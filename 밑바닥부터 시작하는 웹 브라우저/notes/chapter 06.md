# Chapter 6 개발자 스타일 적용하기

## 이론 학습

### 재귀적 하향식 파서

실습에서 구현하는 CSSParser와 같은 파싱 방법을 공식적으로 LL(1) 언어에 대한 재귀적 하향식 파서라고 부른다. 이 방법을 사용하는 파서는 많은 노력을 기울인다면 정말 빠를 수 있다.(https://simdjson.org). 브라우저에서 파싱이 빠르면 페이지가 더 빨리 로드된다.

### 파서의 정확성과 브라우저 보안

> 파서는 임의의 바이트를 입력으로 받기 때문에, 파서의 버그는 악의적인 공격자가 보통 쉽게 악용합니다. 따라서 파서의 정확성은 브라우저 보안에 매우 중요하며, 많은 파서 버그가 이를 증명하고 있습니다. 오늘날 브라우저 개발자들은 이러한 버그를 찾고 수정하기 위해 퍼징(fuzzing)을 사용합니다.

### 텍스트 스타일 처리

- 지금까지의 구현 기준으로 텍스트 노드는 태그 노드와 다르게 셀렉터로 매치할 수 없다. CSS에서 텍스트 스타일이 작동하는 방식을 상속이라고 부른다. 상속은 어떤 노드에 특정 프로퍼티에 대한 값이 없는 경우 부모 노드의 값을 대신 사용하는 것을 의미한다.
- 프로퍼티마다 상속 가능 여부가 다르다. 배경색은 상속되지 않지만 텍스트 색상 및 다른 글꼴 프로퍼티는 상속된다.

### 계산된 스타일

- 폰트 크기와 같은 스타일이 퍼센트로 정의되어 있다면 백분율의 값을 픽셀로 바꾸어 적용해야 한다. 이런 값을 계산된 스타일(computed style)이라고 한다. 
- 실습 브라우저에서는 폰트 크기의 퍼센트 속성에 대한 처리만 다루지만 전체 CSS 표준은 더 복잡하다. 지정된(specified) 값, 계산된(computed) 값, 사용된(used) 값과 실제(actual) 값(https://www.w3.org/TR/CSS2/cascade.html#value-states)이 있으며 font-size 외에도 많은 CSS 프로퍼티에 영향을 준다.
- 페이지 스타일링이 느려질 수 있어서 실제 브라우저는 다양한 기법을 사용한다. 자손 셀렉터를 위해서는 블룸 필터, 단순한 셀렉터는 인덱스를 사용하고 다양한 형태의 공유 기법과 병렬처리가 사용된다. 일부 공유 기법들은 메모리 사용량을 줄이기 위해서도 중요하다. 계산된 스타일시트들은 엄청난 양의 메모리를 차지한다.

## 실습

- CSSParser 클래스 구현
  - HTML 태그의 style 속성에서 CSS 속성을 파싱하는 파서를 구현한다.
  - 공백 문자를 지나가는 whitespace 함수를 구현한다.
  - 프로퍼티 이름을 파싱하는 word 함수를 구현한다.
    - 실습 브라우저에서는 word 함수로 프로퍼티 이름, 숫자, 단위, 색상을 커버하도록 구현한다. 실제 브라우저는 더 복잡한 CSS 구문에 대응해야 한다.
  - ":"과 같은 구분자 확인을 위해 literal 함수를 구현한다.
  - word, whitespace, literal 함수를 이용해 프로퍼티-값 쌍을 파싱하는 pair 함수를 구현한다.
  - 루프를 통해 프로퍼티-값 쌍의 시퀀스를 파싱하는 body 함수를 구현한다.
  - 오류 처리에 대한 대응을 위해 파싱할 수 없는 프로퍼티-값 쌍을 건너띄는 ignore_until 함수를 구현한다.
    - 프로퍼티-값 쌍 시퀀스를 파싱할 때 예외가 발생한다면 ignore_until 함수를 사용해서 다음 속성으로 건너뛴다.
    - 실습 코드에서처럼 포괄적인 예외 처리는 코드 레벨에서는 스멜이지만, 브라우저는 모든 웹페이지를 동작할 수 있게 하는 것을 우선한다.
- HTML 트리 노드의 style 속성 처리
  - 노드의 style 속성을 파싱하여 노드의 필드로 저장하는 style 함수를 구현한다.
  - style 함수는 노드의 children을 탐색하며 재귀적으로 style 속성을 처리한다.
  - style 처리 시점은 HTML 파싱 후, 레이아웃 수행 전으로 한다. 페인트를 수행할 때 스타일 정보를 참조할 수 있다.
    - paint 함수에 background-color 속성을 참조하여 배경색을 처리하는 코드를 추가해본다.
- CSS 셀렉터 파싱
  - 실습 브라우저에서는 태그 셀렉터와 자손(descendant) 셀렉터 두 가지 유형의 셀렉터를 지원하도록 구현한다.
  - 셀렉터의 콘텐츠를 저장하기 위한 TagSelector 클래스를 구현한다.
    - TagSelector 클래스는 특정 노드가 해당 셀렉터에 매치되는지 테스트하는 matches 메서드를 구현한다.
  - 자손 셀렉터를 구현하기 위해 DescendantSelector 클래스를 구현한다.
    - 조상, 자손 관계를 다루기 위해 ancestor, descendant 필드를 사용한다.
    - ancestor, descendant 두 필드 모두 TagSelector이므로 재귀적으로 matches 메서드를 구현할 수 있다.
  - CSSParser 클래스에 셀렉터를 파싱하는 select 메서드를 구현한다.
  - select 메서드를 사용해서 CSS 파일의 셀렉터와 블록을 파싱하는 parse 메서드를 구현한다.
  - 파싱 과정에서 발생할 수 있는 오류 상황을 처리한다.
    - CSS를 파싱하는 과정에서 body를 호출한 경우에는 닫는 중괄호를 만나면 해당 블록의 파싱을 중단해야 한다. ignore_until 함수를 이용해서 다음 셀렉터로 넘어간다.
    - 셀럭터를 파싱하는 동안 예외가 발생한다면 ignore_until 함수를 이용해서 다음 셀렉터로 넘어간다.
- 스타일시트 적용
  - style 함수에 파싱된 CSS 규칙을 전달받아 셀렉터에 해당하는 노드의 스타일 필드에 스타일 속성을 저장하는 처리를 추가한다.
  - 웹 페이지를 로드할 때 기본 스타일시트로 사용할 Browser.css 파일을 정의하고 페이지를 로드할 때 해당 파일의 CSS 규칙을 적용한다.
  - Browser 클래스의 load 메서드에 link 태그로 정의된 스타일시트 파일의 URL 목록을 리스트로 저장하는 처리를 추가한다.
    - 스타일시트의 상대 URL을 전체 URL로 변환하기 위해 URL 클래스의 resolve 메서드로 구현하고 사용한다.
      - 상대 URL 처리에는 쿼리 렐러티브를 포함하여 다양한 방식이 있지만 실습 브라우저에서는 호스트, 경로, 스킴 렐러티브만을 처리한다.
  - 스타일 시트 URL로 스타일시트 파일을 요청하고 응답의 본문을 CSSParser로 파싱한 규칙을 규칙 목록에 추가한다.
- 캐스케이딩 처리 구현
  - Selector 클래스에 캐스케이드 오더 값을 저장하기 위한 priority 필드를 추가한다.
  - 실습 브라우저는 태그 셀렉터만 지원하므로 케스케이드 오더는 카운트만 처리하면 된다.
  - 규칙의 priority 값을 케스케이드 오더로 반환하는 cascade_priority 함수를 구현한다.
  - style 함수를 호출할 때 캐스케이드 오더에 따라 정렬된 규칙을 전달한다.
- 폰트 스타일 적용
  - 실습 브라우저는 font-size, font-style(italic), font-weight(bold), color 네 가지 폰트 프로퍼티에 대한 상속을 구현한다.
  - 지원하는 상속 프로퍼티와 해당 프로퍼티의 기본값을 관리하는 INHERITABLE_PROPERTIES 상수를 정의한다.
  - style 함수에 스타일 속성을 처리할 때 상속 규칙을 적용하는 처리를 추가한다.
    - 명시적인 규칙이 존재한다면 상속된 규칙을 명시된 규칙이 재정의하도록 상속 규칙 처리가 다른 속성 처리보다 먼저 실행되도록 구현한다.
    - 폰트 크기 속성에 퍼센트가 사용되었다면 절대적인 픽셀 크기로 바꾸어 처리한다.
