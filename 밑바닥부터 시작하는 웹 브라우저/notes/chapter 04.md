# Chapter 4 문서 트리 구축하기

## 이론 학습

지금까지 실습 브라우저는 웹페이지를 태그와 텍스트의 나열로 처리했지만, 이제부터 실제 브라우저처럼 트리 구조로 다룬다.

### 노드 트리

- HTML 트리는 태그 쌍을 위한 노드와 텍스트 스팬을 위한 노드를 갖고 있다.
- 소스 코드를 파싱하는 동안 불안전한 트리를 저장하는 순간이 존재한다.
  - 여는 태그 노드는 상응하는 닫는 태그가 나오기 전까지 미완성 상태로 존재한다.
  - 닫는 태그까지 파싱된 노드는 새로운 자식이 추가될 일이 없는 완성된 상태이다.
  - 이와 같은 특징을 HTML 파서 구현에 활용한다.

### `document.write` 메서드 대응

- `document.write` 메서드는 HTML 소스 코드를 파싱하는 사이 소스 코드를 수정할 수 있게 허용한다. 자바스크립트를 실행하기 전에 HTML 파서를 멈춰야 하고, 페이지 뒤에 사용되는 이미지, CSS 및 자바스크립트에 대한 요청이 느려진다.
- 이 문제를 해결하기 위해 모던 브라우저는 파싱이 끝나기 전에 추가 리소스들을 로드하는 예측 파싱(speculative parsing)을 지원한다.

### doctype

SGML에서는 문서 유형(doctype)을 선언할 때 유효한 태그를 정의하는 URL을 포함해서 선언했고 이 방식은 이전 버전의 HTML에서도 권장했다. 현재 브라우저는 문서 유형을 선언하지 않으면 식별을 위해 SGML 이전 버전의 오래된 HTML 버전을 사용한다. 이제는 URL을 사용하지 않기 때문에 `<!doctype html>`이 모던 HTML에 가장 적합한 문서 유형 선언이다.

## 실습

- 트리 노드 정의
  - 텍스트를 다루기 위한 노드로 Text 클래스를 정의한다.
    - 텍스트 노드는 자식 노드가 필요 없지만, 실습에서는 일관성을 위해 Text와 Element 모두에 children 필드를 추가한다.
  - 태그를 다루기 위한 노드로 Element 클래스를 정의한다.
- HTML 파서 구현
  - 미완성 상태의 태그 노드를 관리하기 위해 unfinished 필드를 사용한다.
  - 기존 lex 함수의 코드를 토대로 Element와 Text 노드를 생성하는 parse 메서드를 구현한다.
  - 텍스트 노드를 마지막 미완성 노드의 자식 노드로 추가하는 add_text 메서드를 구현한다.
  - 태그는 여는 태그와 닫는 태그에 따라 다르게 처리해야 한다.
    - 여는 태그는 리스트의 끝에 새 미완성 노드를 추가한다.
    - 닫는 태그는 마지막 미완성 노드를 완성한다. 해당 노드를 꺼내 리스트 안에 있는 이전 미완성 노드에 추가한다.
  - 파싱이 끝나면 미완성 노드를 모두 정리해서 불완전 트리를 완전 트리로 만드는 finish 메서드를 구현한다.
  - HTML 문서의 시작과 끝에서 발생하는 엣지 케이스를 위한 처리를 추가한다.
    - 최초의 여는 태그는 부모가 없는 엣지 케이스이다.
    - 가장 마지막 태그는 처리할 미완성 노드가 없는 엣지 케이스이다.
- 파서 디버깅
  - 파서가 만든 트리를 출력하는 디버깅 함수를 구현한다.
  - 노드 정보를 출력하는 메서드를 구현한다.
  - 실습 브라우저에서는 `<!doctype html>` 태그를 무시하도록 구현한다.
    - 실제 브라우저는 파싱과 레이아웃을 수행할 때, 표준 방식과 레거시 방식 중 하나를 선택하는데 doctype을 사용한다.
    - 실습 브라우저에서는 '!' 시작하는 태그를 모두 무시하도록 구현하는데 doctype뿐만 아니라 HTML 주석도 무시된다.
  - 공백 문자만으로 이루어진 텍스트 노드를 무시하도록 구현한다.
    - `<!doctype html>` 태그 이후 공백 문자가 있을 경우 에러가 발생한다.
    - 실제 브라우저는 공백 문자를 유지하여 올바르게 렌더링을 처리한다. 실습 브라우저는 이후 내용의 간소화를 위해 무시한다.
- 셀프 클로징 태그 처리
  - 셀프 클로징 태그 목록을 리스트로 관리한다.
    - 실제 브라우저는 실습 브라우저와 다르게 잘 사용되지 않는 여러 셀프 클로징 태그들도 추가로 지원한다.
  - 셀프 클로징 태그는 파서가 자동으로 닫도록 구현한다.
- attribute 처리
  - HTML 태그의 attribute를 처리하는 메서드를 추가한다.
  - Element 클래스에 attributes 필드를 추가한다.
- 문서 트리 적용
  - 기존 Layout 클래스가 토큰이 아닌 문서 트리의 태그를 통해 텍스트의 스타일과 크기를 처리하도록 변경한다.
  - Browser 클래스가 HTMLParser를 사용해 문서 트리를 생성하고 Layout 클래스에게 전달하도록 변경한다.
