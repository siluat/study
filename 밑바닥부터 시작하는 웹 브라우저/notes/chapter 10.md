# Chapter 10 사용자 데이터 보호하기

## 이론 학습

'쿠키를 통한 사용자 신원 인증'으로 개인화된 온라인 서비스를 실행할 수 있다. 하지만 브라우저는 쿠키를 훔치려는 공격자로부터 쿠키를 안전하게 지켜야 한다. 웹 브라우저는 쿠키에 대한 접근을 통제하고 오용을 방지하기 위한 정교한 시스템을 갖추고 있다.

### 쿠키

지금까지 구현한 것만으로는 웹 서버가 두 개의 HTTP 요청이 동일한 사용자로부터 왔는지 서로 다른 사용자로부터 왔는지 알 수 없다. 웹은 쿠키로 이 문제를 해결한다. 쿠키는 웹 서버를 대신하여 브라우저에 저장되는 정보이다. 여러 웹 요청이 전송됐을 때 서버는 쿠키를 통해 각 요청이 어디서 왔는지 구분할 수 있다.

브라우저는 키-값 쌍의 쿠키를 기억하여, 이후 같은 서버로 요청할 때 쿠키 헤더로 되돌려준다.

서버는 여러 개의 쿠키를 설정할 수 있고, 만료 날짜와 같은 매개변수도 설정할 수 있다.

### 동일 출처 정책(Same-origin policy)

XMLHttpRequest를 이용하면 서버의 웹페이지 콘텐츠가 다른 서버에서 온 웹페이지의 자바스크립트로 전달될 수 있다. 이를 악용하여 프라이빗 데이터에 접근할 수도 있다. 이와 같은 문제를 방지하기 위해 브라우저는 XMLHttpRequest와 같은 요청의 경우에 같은 origin, 다시 말해 같은 스킴, 같은 호스트명, 같은 포트를 가진 웹페이지만 전송을 허용한다.

### 교차 사이트 요청 위조(Cross-site request forgery, CSRF)

서버에서는 사용자 세션과 연결된 논스(nonce)값을 발급하여 폼에 부여하고, 폼 요청을 수신시 해당 논스를 검증하여 CSRF 공격을 방어한다.

웹 브라우저는 모든 웹사이트가 CSRF 공격에 대응할 것이라 기대하지 않고 SameSite 쿠키라는 안전한 솔루션을 제공한다.

> CSRF 공격과 유사한 방식의 공격 중 하나는 클릭재킹이다. 투명한 iframe을 사용해 외부 사이트를 공격자의 사이트 위에 배치한다. 사용자는 한 사이트에서 클릭을 하고 있다고 생각하지만, 실제로는 다른 사이트에서 동작을 수행하게 된다. 오늘날의 사이트는 Content-Security-Policy의 frame-ancestors 지시어나 X-Frame-Options 헤더를 사용해 방지할 수 있다.

## 실습

- 실습용 서버에 쿠키 헤더 읽기/쓰기, 토큰 발급, 세션 저장 기능 추가
- 실습용 서버에 간소화된 로그인 및 로그인한 사용자에게만 글 작성을 허용하는 기능 추가
- 브라우저에 쿠키 저장 공간 추가
  - 쿠키들은 사이트별로 관리되므로 사이트를 쿠키들에 매핑한다.
  - URL 클래스의 request 메서드에서 요청을 전송할 때 대상 호스트로 저장된 쿠키가 있다면 쿠키 헤더에 해당 쿠키값을 추가한다.
  - URL 클래스의 request 메서드에서 응답을 처리할 때 쿠키 헤더가 있다면 쿠키 저장 공간에 해당 쿠키값을 저장한다.
  - 실제 브라우저는 하나의 요청에 여러 개의 Set-Cookie 헤더를 전송하는 경우도 처리할 수 있어야 한다.
- 동기식 XMLHttpRequest 구현
  - 자바스크립트 런타임에 XMLHttpRequest 객체를 구현한다.
  - XMLHttpRequest 객체의 open 메서드를 구현한다. open 메서드는 요청 url, method를 초기화한다.
  - XMLHttpRequest 객체의 send 메서드를 구현한다. send 메서드는 body를 전달받고 전송한다. 전송에는 브라우저 런타임에서 익스포트하는 XMLHttpRequest_send 함수를 사용한다.
  - JSContext 클래스에 XMLHttpRequest_send 메서드를 추가한다. XMLHttpRequest_send 메서드는 URL 클래스의 request 메서드를 사용하여 요청을 전송하고 응답 본문을 반환한다.
- 동일 출처 정책 구현
  - URL 클래스에 origin을 반환하는 origin 메서드를 추가한다.
  - XMLHttpRequest_send 메서드에서 현재 페이지의 URL과 요청 URL의 origin을 비교해서 동일하지 않다면 예외를 발생시킨다.
- SameSite 쿠키 구현
  - 실습 브라우저는 Lax와 None만 구현한다. 기본값은 None으로 설정한다.
  - URL 객체의 request 메서드에서 응답 헤더 처리시 Set-Cookie 헤더에서 파라미터를 추출하여 저장한다.
    - request를 전송할 때는 파라미터를 제외한 쿠키 값만 전송한다.
  - SameSite 처리를 위해 referrer 추적을 위한 매개변수를 request 메서드에 추가하고 request 메서드를 호출하는 모든 곳에서 최상위 URL을 전송하도록 변경한다.
    - SameSite 쿠키는 리퍼러가 아닌 '최상위 사이트'로 쿠키를 전송해야 할지 결정한다. 다만, 둘의 차이는 크지 않으므로 실습 브라우저는 단순화하여 처리한다.
  - request 메서드는 요청 전송시 SameSite 파라미터와 리퍼러 정보를 참조하여 쿠키값 전송 여부를 결정하여 처리한다.
    - 실습 브라우저에서는 최상위 URL과 요청하는 URL의 호스트명만 비교하지만, 실제 브라우저는 더 복잡한 규칙이 적용된다.
    - SameSite에 대한 전체 명세가 존재하지만 실제 브라우저마다 이 기능의 다른 부분을 지원하거나 기본값이 다르다. 이런 상황이 발생하는 주된 이유는 기존 웹사이트와의 하위 호환성 유지 때문이다.
