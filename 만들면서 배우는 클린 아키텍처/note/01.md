# 01. 계층형 아키텍처의 문제는 무엇일까?

저자에 의하면, 잘 만들어진 계층형 아키텍처는 선택의 폭을 넓히고 변화하는 요구사항과 외부 요인에 빠르게 적응할 수 있게 해준다. 다만 계층형 아키텍처는 코드에 나쁜 습관들이 스며들기 쉽게 만들고 시간이 지날수록 소프트웨어를 점점 더 변경하기 어렵게 만드는 수많은 허점들을 노출한다.

계층형 아키텍처는

- 데이터베이스 주도 설계를 유도한다.
- 지름길을 택하기 쉬워진다.
- 테스트하기 어려워진다.
- 유스케이스를 숨긴다.
- 동시 작업이 어려워진다.

## 데이터베이스 주도 설계를 유도한다

- 전통적인 계층형 아키텍처의 토대는 데이터베이스이고 모든 것이 영속성 계층을 토대로 만들어진다. 데이터베이스의 구조를 먼저 생각하고 도메인 로직을 구현한다.
- 도메인 계층에서 데이터베이스 엔티티를 사용하는 것은 영속성 계층과의 강한 결합을 유발한다. (영속성 코드가 도메인 코드에 녹아들어가기 쉽다)
  - 특히 ORM 사용시 더 쉽게 발생하는 일이다.
- 도메인 로직을 먼저 만들고, 로직을 제대로 이해했는지 맞는지를 확인한 후에 이를 기반으로 영속성 계층과 웹 계층을 만들어야 한다.

## 지름길을 택하기 쉬워진다

- 전통적인 계층형 아키텍처에서는 '특정한 계층에서는 같은 계층에 있는 컴포넌트나 아래에 있는 계층에만 접근 가능하다'는 규칙 외에는 강제하는 규칙이 없다.
- 특정 컴포넌트의 접근 편의를 위해 해당 컴포넌트를 계층을 아래로 내리는 행위가 반복되기 쉽고(특히나 마감이 다가오는 상황이라면 더더욱), 수년에 걸친 개발과 유지보수로 하위 계층들은 비대해지기 쉽다.

> '지름길 모드'를 끄고 싶다면, 추가적인 아키텍처 규칙을 강제해야 한다. '강제한다'는 것은 시니어 개발자가 코드 리뷰를 한다는 것이 아니라 해당 규칙이 깨졌을 때 빌드가 실패하도록 만드는 규칙을 의미한다.

## 테스트하기 어려워진다

- 계층형 아키텍처에서는 계층을 건너뛰는 접근도 발생하게 되는데 반복될수록
  - 애플리케이션 전반에 걸쳐 책임이 섞이고 핵심 도메인 로직들이 퍼져나갈 확률이 높다.
  - 특정 계층 테스트에서 모킹해야하는 계층들이 많아지고 단위 테스트의 복잡도가 올라간다. 테스트 설정이 복잡해지는 것은 테스트를 전혀 작성하지 않는 방향으로 가는 첫 걸음이다.

## 유스케이스를 숨긴다

- 앞서 언급한대로 계층형 아키텍처는 도메인 로직이 여러 계층에 걸쳐 흩어지기 쉽다. 기능을 추가하거나 변경할 때 적절한 위치를 찾기 어려워지는 문제로 이어진다.
- 계층형 아키텍처는 도메인 서비스의 '너비'에 관한 규칙을 강제하지 않아서 시간이 지나면 여러 개의 유스케이스를 담당하는 아주 넓은 서비스가 만들어지기도 한다. 그런 서비스들이 있다면 테스트하기도 어려워지고 작업해야 할 유스케이스의 위치를 찾기도 어려워진다.

## 동시 작업이 어려워진다

- 영속성 계층 -> 도메인 계층 -> 웹 계층 순서로 만들어야하는데, 때문에 특정 기능은 동시에 한 명의 개발자만 작업할 수 있다. 사전에 인터페이스를 함께 정의한 후에 작업을 진행할 수도 있지만, 데이터베이스 주도 설계를 하지 않아야만 가능하다.
- 앞에서 언급한 넓은 서비스도 동시 작업에 방해가 된다. 같은 서비스를 동시에 편집하는 상황이 발생해서 병합 충돌이 발생할 가능성이 높다.
