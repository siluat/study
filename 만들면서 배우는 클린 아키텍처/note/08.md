# 08 경계 간 매핑하기

이 장애서는 두 계층 간 모델을 매핑해서 계층마다 다른 모델을 사용하는 것과 매핑을 하지 않고 다른 계층에서 같은 모델을 사용하는 것의 장단점을 다룬다.

## '매핑하지 않기' 전략

- `SendMoneyUseCase`의 경우 단일 `Account` 모델을 사용한다면 애플리케이션 계층, 웹 계층, 영속성 계층 모두 `Account` 클래스에 접근해야 한다.
- 웹 계층이나 영속성 계층은 모델에 대해 특별한 요구사항이 있을 수 있고, `Account` 클래스는 그런 모든 요구사항을 다뤄야 한다. 또한 `Account` 클래스는 웹, 애플리케이션, 영속성 계층 등 변경될 이유가 많아진다.
- '매핑하지 않기' 전략이 딱 들어맞을 때도 있다. 간단한 CRUD 유스케이스의 경우 모든 계층이 정확히 같은 구조, 같은 정보를 필요로 한다면 '매핑하지 않기' 전략은 완벽한 선택이다. 단, 애플리케이션 또는 도메인 계층에서 웹과 영속성 문제를 다루게 된다면 곧바로 다른 전략을 취해야 한다.

## '양방향' 매핑 전략

- 각 계층이 전용 모델을 가진 매핑 전략을 '양방향' 매핑 전략이라고 한다.
- 도메인 모델이 웹이나 영속성 관심사로 오염되지 않는다.
- 매핑 책임이 명확해서 사용하기 간단한 전략이다.
- 단점으로는 너무 많은 보일러 플레이트 코드, 그리고 도메인 모델이 계층 경계를 넘어 통신하는 데 사용된다는 것이다.
- 은총알은 없다. 각 유스케이스마다 적절한 전략을 택할 수 있어야 한다.

## '완전' 매핑 전략

- 각 연산마다 별도의 입출력 모델을 사용한다. 예제 코드의 `SendMoneyCommand` 같은 클래스가 이에 해당한다.
- 더 많은 코드가 필요하지만 다른 매핑 전략에 비해 구현하고 유지보수하기가 훨씬 쉽다.
- 전역 패턴으로는 추천하지 않는다. 웹 계층(또는 다른 인커밍 어댑터)과 애플리케이션 계층 사이에서 상태 변경 유스케이스의 경계를 명확하게 할 때 가장 좋다. 애플리케이션과 영속성 계층 사이에서는 매핑 오버헤드 때문에 사용하지 않는 것이 좋다.
- 어떤 매핑 전략도 모든 계층에 걸쳐 전역 규칙일 필요가 없다.

## '단방향' 매핑 전략

- 모든 계층의 모델들이 같은 인터페이스를 구현한다.
- 도메인 모델 자체의 풍부한 행동을 구현할 수 있으면서, 매핑 없이 도메인 객체를 바깥 계층으로 전달할 수 있다. 바깥 계층에서 애플리케이션 계층으로 전달하는 객체들도 마찬가지이다.
- 매핑 책임은 다른 계층으로부터 객체를 받은 계층에 있다.
- 매핑이 계층을 넘나들며 퍼져 있어 개념적으로 어렵다.
- 읽기 전용 연산과 같이 계층 간의 모델이 비슷할 때 가장 효과적이다.

## 언제 어떤 매핑 전략을 사용할 것인가?

- 각 매핑 전략이 장단점을 갖고 있기 때문에 한 전략을 전체 코드에 대한 어떤 경우에도 변하지 않는 전역 규칙으로 정의하려는 충동을 이겨내야 한다. 같은 코드에 여러 패턴을 섞으며 어수선하게 느껴져서 우리의 본능을 거스르는 일이기는 하지만 특정 작업에 최선의 패턴이 아님에도 그저 깔끔하게 느껴진다는 이유로 선택해버리는 것은 참으로 무책임한 처사다.
- 소프트웨어는 시간이 지나며 변화를 거듭한다. 간단한 전략으로 시작해서 계층 간 결합을 떼어내는 데 도움이 되는 복잡한 전략으로 갈아타는 것도 괜찮은 방법이다.
- 언제 어떤 전략을 사용할지 팀 내 가이드라인을 정해두는 것이 좋다. 가이드라인은 팀 차원에서 지속적으로 논의하고 수정해야 한다.

### 가이드라인 예시

- **변경 유스케이스**를 작업하고 있다면 **웹 계층과 애플리케이션 계층 사이에서는** 유스케이스 간의 결합을 제거하기 위해 '완전 매핑' 전략을 첫 번째 선택지로 택해야 한다. 이렇게 하나면 유스케이스별 유효성 검증 규칙이 명확해지고 특정 유스케이스에서 필요하지 않은 필드를 다루지 않아도 된다.
- **변경 유스케이스**를 작업하고 있다면 **애플리케이션과 영속성 계층 사이에서는** 매핑 오버헤드를 줄이고 빠르게 코드를 짜기 위해서 '매핑하지 않기' 전략을 첫 번째 선택지로 둔다. 하지만 애플리케이션 계층에서 영속성 문제를 다뤄야 하게 되면 '양방향' 매핑 전략으로 바꿔서 영속성 문제를 영속성 계층에 가둘 수 있게 한다.
- **쿼리** 작업을 한다면 매핑 오버헤드를 줄이고 빠르게 코드를 짜기 위해 '매핑하지 않기' 전략이 **웹 계층과 애플리케이션 계층 사이, 애플리케이션 계층과 영속성 계층 사이** 첫 번째 선택지가 돼야 한다. 하지만 애플리케이션 계층, 애플리케이션 계층과 영속성 계층 사이에서 각각 '양방향' 매핑 전략으로 바꿔야 한다.

## 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

- 상황별로 매핑 전략을 선택하는 것은 모든 상황에 같은 매핑 전략을 사용하는 것보다 더 어렵고 더 많은 커뮤니케이션을 필요로 하겠지만 매핑 가이드라인이 있는 한, 코드가 정확히 해야 하는 일만 수행하면서도 더 유지보수하기 쉬운 코드로 팀에 보상이 되어 돌아올 것이다.
