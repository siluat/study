# 06 영속성 어댑터 구현하기

영속성 계층에 대한 애플리케이션 계층의 의존성을 역전시키기 위해 영속성 계층을 애플리케이션 계층의 플러그인으로 만든다.

## 의존성 역전

영속성 계층에 대한 도메인 코드의 의존성을 없애기 위해 간접 계층인 포트를 사용한다.

## 영속성 어댑터의 책임

1. 입력을 받는다.
2. 입력을 데이터베이스 포맷으로 매핑한다.
3. 입력을 데이터베이스로 보낸다.
4. 데이터베이스 출력을 애플리케이션 포맷으로 매핑한다.
5. 출력을 반환한다.

- 영속성 어댑터의 입출력 모델이 애플리케이션 코어에 있기 때문에 영속성 내부를 변경하는 것이 코어에 영향을 주지 않는다.

## 포트 인터페이스 나누기

- 모든 상황에 적용할 수는 없겠지만, 인터페이스 분리 원칙에 따라 '포트 하나당 하나의 메서드'를 가지는 것이 좋다.
- 각 서비스는 실제 필요한 메서드에만 의존하게 된다.

## 영속성 어댑터 나누기

- '애그리거트당 하나의 영속성 어댑터' 접근 방식 또한 여러 개의 바운디드 컨텍스트의 영속성 요구사항을 분리하기 위한 좋은 토대가 된다.

## 스프링 데이터 JPA 예제

- Account와 Activity 도메인 모델, AccountJpaEntity와 ActivityJpaEntity 데이터베이스 모델 간 양방향 매핑을 한다.
- 매핑없이 도메인 모델을 그대로 영속성 계층에서 사용한다면, 영속성 계층의 특성이 도메인 모델에 영향을 주게 된다. 영속성 측면과의 타협 없이 풍부한 도메인 모델을 생성하고 싶다면 도메인 모델과 영속성 모델을 매핑하는 것이 좋다.
- 매핑하지 않는 것이 유효한 전략일 수도 있다. 8장에서 다룬다.

## 데이터베이스 트랜잭션은 어떻게 해야 할까?

- 영속성 어댑터는 어떤 데이터베이스 연산이 같은 유스케이스에 포함되는지 알지 못하기 때문에 언제 트랜잭션을 열고 닫을지 결정할 수 없다. 이 책임은 영속성 어댑터를 호출하는 서비스에 위임해야 한다.
- 만약 서비스가 `@Transactional` 애너테이션으로 오염되지 않고 깔끔하게 유지되길 원한다면 AOP로 트랜잭션 경계를 코드에 위빙할 수 있다.

## 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?

- 도메인 코드에 플러인처럼 동작하는 영속성 어댑터를 만들면 도메인 코드가 영속성과 관련된 것들로부터 분리되어 풍부한 도메인 모델을 만들 수 있다.
- 좁은 인터페이스를 사용하면 포트마다 다른 방식으로 구현할 수 있는 유연함이 생긴다. 심지어 포트의 명세만 지켜진다면 영속성 계층 전체를 교체할 수도 있다.
